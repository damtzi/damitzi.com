---
import { getCollection } from "astro:content";
import Breadcrumbs from "@/components/shared/breadcrumbs.astro";
import BaseLayout from "@/layouts/base-layout.astro";
import { dateFormatter } from "@/lib/utils";

const concerts = await getCollection("concerts");

// Sort concerts by date (newest first, oldest last)
const sortedConcerts = concerts.sort(
    (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

// Group concerts by year
const concertsByYear = sortedConcerts.reduce(
    (acc, concert) => {
        const year = new Date(concert.data.date).getFullYear();
        if (!acc[year]) {
            acc[year] = [];
        }
        acc[year].push(concert);
        return acc;
    },
    {} as Record<number, typeof concerts>,
);

// Get years in descending order (newest first)
const years = Object.keys(concertsByYear)
    .map(Number)
    .sort((a, b) => b - a);
---

<BaseLayout title="damitzi | my concerts">
    <div class="flex flex-col gap-4">
        <h1 class="text-2xl font-serif font-medium">My concerts</h1>
        <Breadcrumbs />
        <div class="space-y-6 w-full">
            {
                years.map((year) => (
                    <div class="space-y-2">
                        <h2 class="text-lg font-semibold font-mono text-gray-500 border-b border-gray-200 pb-1">
                            {year}
                        </h2>
                        <ul class="space-y-2 w-full">
                            {concertsByYear[year].map((concert) => (
                                <li class="flex flex-col md:flex-row md:items-center md:justify-between group">
                                    <span>{concert.data.artist}</span>
                                    <span>
                                        {dateFormatter(concert.data.date)} @{" "}
                                        {concert.data.location}{" "}
                                        {concert.data.festival &&
                                            `[${concert.data.festival} Festival]`}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    </div>
                ))
            }
        </div>
    </div>
</BaseLayout>
